<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Campus Dashboard v9 (Admin Access with UI)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #001f3f, #00509e);
            color: #fff;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-top: 30px;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            letter-spacing: 1px;
        }

        .room-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 10px;
        }

        .nav-item {
            width: 100%;
            padding: 10px 15px;
            cursor: pointer;
            transition: 0.3s;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
        }

        .nav-item span {
            margin-left: 8px;
        }

        /* Room Manager Section */
        .room-manager {
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding: 15px 15px 20px 15px;
            background: rgba(255, 255, 255, 0.05);
        }

        .room-manager h3 {
            text-align: center;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .room-manager input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 6px;
            margin-bottom: 6px;
            text-align: center;
        }

        .room-manager button {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 6px;
            background: #ffffff33;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }

        .room-manager button:hover {
            background: #ffffff55;
        }

        /* Main */
        .main {
            margin-left: 250px;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 30px 50px;
            overflow-y: auto;
            height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.6rem;
        }

        /* Dashboard */
        .dashboard {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            text-align: center;
            animation: fadeIn 1.2s ease-in-out;
            margin-bottom: 30px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .count {
            font-size: 4rem;
            color: #ffeb3b;
            text-shadow: 0 0 15px rgba(255, 235, 59, 0.8);
            font-weight: 700;
            margin: 10px 0;
        }

        .status {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            font-size: 1rem;
        }

        .light-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: red;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
            transition: 0.3s;
        }

        .on {
            background-color: #00e676;
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.9);
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        button {
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            background: #ffffff33;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-3px);
            background: #ffffff55;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        th,
        td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        th {
            background: rgba(255, 255, 255, 0.15);
            font-weight: 600;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .on-status {
            color: #00e676;
            font-weight: bold;
        }

        .off-status {
            color: #ff5252;
            font-weight: bold;
        }

        footer {
            text-align: center;
            margin-top: auto;
            padding: 15px;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* Password Modal */
        .modal-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
            animation: fadeIn 0.3s ease;
        }

        .modal {
            background: #fff;
            color: #333;
            padding: 30px;
            border-radius: 12px;
            width: 320px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal h2 {
            margin-bottom: 15px;
        }

        .modal input {
            width: 90%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 1rem;
            text-align: center;
        }

        .modal button {
            width: 45%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: #00509e;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            margin: 0 5px;
        }

        .modal button:hover {
            background: #0077ff;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div>
            <h2>üè´ Smart Campus</h2>
            <div class="room-section" id="roomList"></div>
        </div>

        <div class="room-manager">
            <h3>üõ† Room Manager</h3>
            <input type="text" id="newRoom" placeholder="Enter room name" />
            <button onclick="requestAdmin(addRoom)">‚ûï Add Room</button>
            <button onclick="requestAdmin(removeRoom)">‚ùå Remove Current Room</button>
        </div>
    </div>

    <!-- Main -->
    <div class="main">
        <div class="header">
            <h1 id="roomName">Dashboard</h1>
        </div>

        <div class="dashboard">
            <div class="status">
                <div id="light" class="light-indicator"></div>
                <span id="light-status">Light: OFF</span>
            </div>
            <div id="count" class="count">0</div>
            <div>Total People Inside</div>

            <div class="buttons">
                <button onclick="increase()">Enter</button>
                <button onclick="decrease()">Exit</button>
                <button onclick="requestAdmin(toggleLight)">Toggle Light</button>
            </div>
        </div>

        <h2>üè¢ Room Comparison Panel</h2>
        <table id="roomTable">
            <thead>
                <tr>
                    <th>Room Name</th>
                    <th>Current Count</th>
                    <th>Light Status</th>
                    <th>% Occupancy</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <footer>Developed by Team SmartSpace ‚Ä¢ 2025</footer>
    </div>

    <!-- Password Modal -->
    <div class="modal-bg" id="modal-bg">
        <div class="modal">
            <h2>üîí Admin Access Required</h2>
            <input type="password" id="passwordInput" placeholder="Enter Password">
            <div>
                <button onclick="verifyPassword()">Submit</button>
                <button onclick="closeModal()">Cancel</button>
            </div>
            <p id="errorMsg" style="color:red; margin-top:10px; display:none;">‚ùå Incorrect Password</p>
        </div>
    </div>

   
    <!-- <script>
        // ---------------------------
        // CONFIG: change this when deploying
        // ---------------------------
        const API_BASE = ""; // leave empty for same host (served by Flask). If using ngrok or separate host set "https://xxxx.ngrok.io"
        const ADMIN_PASSWORD = "1234"; // demo-only: should match ADMIN_TOKEN in .env
        const DEVICE_POLL_INTERVAL = 3000; // if you poll device in frontend for anything
        // ---------------------------

        let pendingAction = null;
        let rooms = {}; // will be filled from backend
        let currentRoom = null;
        const maxCapacity = 100;

        // UI helpers
        function byId(id) { return document.getElementById(id); }

        async function fetchStatus() {
            try {
                const url = (API_BASE || "") + "/api/status";
                const res = await fetch(url);
                if (!res.ok) throw new Error("status fetch failed");
                const json = await res.json();
                // map rooms
                rooms = {};
                json.rooms.forEach(r => {
                    rooms[r.name] = { count: r.count, lightOn: r.lightOn };
                });
                if (!currentRoom) currentRoom = Object.keys(rooms)[0];
                renderRoomList();
                updateDisplay();
            } catch (err) {
                console.error("fetchStatus error:", err);
                // fallback: use localStorage if available
                const local = JSON.parse(localStorage.getItem('roomsData') || "{}");
                if (Object.keys(local).length) {
                    rooms = local;
                    if (!currentRoom) currentRoom = Object.keys(rooms)[0];
                    renderRoomList();
                    updateDisplay();
                }
            }
        }

        // render sidebar room list
        function renderRoomList() {
            const list = byId('roomList');
            list.innerHTML = '';
            for (let r in rooms) {
                const div = document.createElement('div');
                div.classList.add('nav-item');
                if (r === currentRoom) div.classList.add('active');
                div.innerHTML = `<span>${r}</span>`;
                div.onclick = (e) => selectRoom(r, e);
                list.appendChild(div);
            }
        }

        // Admin Modal Logic
        function requestAdmin(action) {
            pendingAction = action;
            byId('passwordInput').value = '';
            byId('errorMsg').style.display = 'none';
            byId('modal-bg').style.display = 'flex';
        }

        function verifyPassword() {
            const entered = byId('passwordInput').value;
            if (entered === ADMIN_PASSWORD) {
                closeModal();
                pendingAction();
            } else {
                byId('errorMsg').style.display = 'block';
            }
        }

        function closeModal() {
            byId('modal-bg').style.display = 'none';
        }

        // local save for fallback
        function saveLocal() { localStorage.setItem('roomsData', JSON.stringify(rooms)); }

        // UI actions
        function addRoomLocal(name) {
            if (!name || rooms[name]) return alert("Enter a unique room name!");
            rooms[name] = { count: 0, lightOn: false };
            currentRoom = name;
            saveLocal();
            renderRoomList();
            updateDisplay();
        }

        async function addRoom() {
            // For simplicity, add on frontend and DB via "fake update": create room via PUT by posting update 0
            const name = byId('newRoom').value.trim();
            if (!name || rooms[name]) return alert("Enter a unique room name!");
            // Create in DB by hitting /api/update with device token (can't from frontend securely). We'll do a local create then ask backend admin to create a command.
            // Simpler: call /api/command with admin token instructing server to create room: but server currently creates room when device posts.
            // For demo, add locally and save; recommend hardware member to post first ESP32 update for new room, or create a dedicated endpoint (we can add if needed).
            addRoomLocal(name);
            byId('newRoom').value = '';
            // optionally push to backend via admin command that backend can interpret to create room (not implemented server-side)
        }

        function removeRoomLocal() {
            if (Object.keys(rooms).length <= 1) return alert("At least one room must remain!");
            delete rooms[currentRoom];
            currentRoom = Object.keys(rooms)[0];
            saveLocal();
            renderRoomList();
            updateDisplay();
        }

        async function removeRoom() {
            // Local removal and save; server-side removal should be admin-only and implemented through an admin endpoint if required.
            removeRoomLocal();
        }

        function increase() {
            rooms[currentRoom].count++;
            // auto-light behavior local + send update via backend (for demo)
            if (rooms[currentRoom].count >= 1) rooms[currentRoom].lightOn = true;
            updateDisplay();
            sendUpdateToBackend(currentRoom);
        }
        function decrease() {
            if (rooms[currentRoom].count > 0) rooms[currentRoom].count--;
            if (rooms[currentRoom].count === 0) rooms[currentRoom].lightOn = false;
            updateDisplay();
            sendUpdateToBackend(currentRoom);
        }

        function toggleLightLocal() {
            rooms[currentRoom].lightOn = !rooms[currentRoom].lightOn;
            updateDisplay();
            // send manual command to backend
            sendCommandToBackend(currentRoom, "setLight", rooms[currentRoom].lightOn);
        }

        function toggleLight() {
            requestAdmin(toggleLightLocal);
        }

        function selectRoom(room, event) {
            currentRoom = room;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            event.currentTarget.classList.add('active');
            updateDisplay();
        }

        function updateDisplay() {
            if (!currentRoom) return;
            const room = rooms[currentRoom];
            byId('roomName').innerText = `${currentRoom} Dashboard`;
            byId('count').innerText = room.count;
            const light = byId('light');
            const status = byId('light-status');
            if (room.lightOn) {
                light.classList.add('on');
                status.innerText = 'Light: ON';
            } else {
                light.classList.remove('on');
                status.innerText = 'Light: OFF';
            }
            updateTable();
            saveLocal();
        }

        function updateTable() {
            const tbody = document.querySelector('#roomTable tbody');
            tbody.innerHTML = '';
            for (let r in rooms) {
                const { count, lightOn } = rooms[r];
                const occupancy = Math.min(((count / maxCapacity) * 100).toFixed(1), 100);
                tbody.innerHTML += `
        <tr>
          <td>${r}</td>
          <td>${count}</td>
          <td class="${lightOn ? 'on-status' : 'off-status'}">${lightOn ? 'ON' : 'OFF'}</td>
          <td>${occupancy}%</td>
        </tr>`;
            }
        }

        // ---------------------------
        // Backend communications
        // ---------------------------
        async function sendUpdateToBackend(roomName) {
            try {
                const payload = { room: roomName, count: rooms[roomName].count, lightOn: rooms[roomName].lightOn };
                const url = (API_BASE || "") + "/api/update";
                // Note: this endpoint requires DEVICE_TOKEN header. For demo with frontend-only, this will be unauthorized.
                // Proper flow: ESP32 should send /api/update. Frontend should not pretend to be device in real system.
                await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
            } catch (err) {
                console.warn("sendUpdateToBackend failed (expected when not authenticated from browser):", err);
            }
        }

        async function sendCommandToBackend(roomName, action, value) {
            try {
                const payload = { room: roomName, action: action, value: value };
                const url = (API_BASE || "") + "/api/command";
                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "x-api-key": ADMIN_PASSWORD },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    const t = await res.json().catch(() => ({}));
                    console.warn("command error", res.status, t);
                    alert("Command failed: check server or token");
                    return;
                }
                const j = await res.json();
                console.log("Command created:", j);
                // Optionally poll /api/commands from ESP32 side (backend -> device)
                // For immediate UI change, frontend already toggles the UI (above)
            } catch (err) {
                console.error("sendCommandToBackend error:", err);
            }
        }

        // initial load
        (function init() {
            // fetch status once and then poll
            fetchStatus();
            setInterval(fetchStatus, 3000);
        })();

    </script> -->

    <script>
        // ---------------------------
        // CONFIG
        // ---------------------------
        const API_BASE = "";
        const ADMIN_PASSWORD = "1234";

        // ---------------------------

        let pendingAction = null;
        let rooms = {};
        let currentRoom = null;
        const maxCapacity = 100;

        // NEW: Variable to track when we last clicked the button
        let lastManualToggleTime = 0;

        function byId(id) { return document.getElementById(id); }

        async function fetchStatus() {
            try {
                const url = (API_BASE || "") + "/api/status";
                const res = await fetch(url);
                if (!res.ok) throw new Error("status fetch failed");
                const json = await res.json();

                // Map rooms
                json.rooms.forEach(r => {
                    // LOGIC FIX:
                    // If we are looking at the current room AND we clicked the button less than 4 seconds ago...
                    // Then DO NOT overwrite the light status. Trust the user's click.
                    const isRecentlyToggled = (r.name === currentRoom) && (Date.now() - lastManualToggleTime < 4000);

                    if (!rooms[r.name]) rooms[r.name] = {};

                    rooms[r.name].count = r.count; // Always accept count updates

                    if (!isRecentlyToggled) {
                        rooms[r.name].lightOn = r.lightOn; // Only accept light update if NOT recently toggled
                    }
                });

                if (!currentRoom) currentRoom = Object.keys(rooms)[0];
                renderRoomList();
                updateDisplay();
            } catch (err) {
                console.error("fetchStatus error:", err);
            }
        }

        function renderRoomList() {
            const list = byId('roomList');
            list.innerHTML = '';
            for (let r in rooms) {
                const div = document.createElement('div');
                div.classList.add('nav-item');
                if (r === currentRoom) div.classList.add('active');
                div.innerHTML = `<span>${r}</span>`;
                div.onclick = (e) => selectRoom(r, e);
                list.appendChild(div);
            }
        }

        function requestAdmin(action) {
            pendingAction = action;
            byId('passwordInput').value = '';
            byId('errorMsg').style.display = 'none';
            byId('modal-bg').style.display = 'flex';
        }

        function verifyPassword() {
            const entered = byId('passwordInput').value;
            if (entered === ADMIN_PASSWORD) {
                closeModal();
                pendingAction();
            } else {
                byId('errorMsg').style.display = 'block';
            }
        }

        function closeModal() { byId('modal-bg').style.display = 'none'; }

        // --- ACTIONS ---

        function increase() {
            rooms[currentRoom].count++;
            if (rooms[currentRoom].count >= 1) rooms[currentRoom].lightOn = true;
            updateDisplay();
            sendUpdateToBackend(currentRoom);
        }
        function decrease() {
            if (rooms[currentRoom].count > 0) rooms[currentRoom].count--;
            if (rooms[currentRoom].count === 0) rooms[currentRoom].lightOn = false;
            updateDisplay();
            sendUpdateToBackend(currentRoom);
        }

        function toggleLightLocal() {
            // 1. Update UI immediately
            rooms[currentRoom].lightOn = !rooms[currentRoom].lightOn;

            // 2. Record the time so we ignore the server for 4 seconds
            lastManualToggleTime = Date.now();

            updateDisplay();

            // 3. Send command
            sendCommandToBackend(currentRoom, "setLight", rooms[currentRoom].lightOn);
        }

        function toggleLight() {
            requestAdmin(toggleLightLocal);
        }

        function selectRoom(room, event) {
            currentRoom = room;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            event.currentTarget.classList.add('active');
            updateDisplay();
        }

        function updateDisplay() {
            if (!currentRoom) return;
            const room = rooms[currentRoom];
            byId('roomName').innerText = `${currentRoom} Dashboard`;
            byId('count').innerText = room.count;
            const light = byId('light');
            const status = byId('light-status');
            if (room.lightOn) {
                light.classList.add('on');
                status.innerText = 'Light: ON';
            } else {
                light.classList.remove('on');
                status.innerText = 'Light: OFF';
            }
            updateTable();
        }

        function updateTable() {
            const tbody = document.querySelector('#roomTable tbody');
            tbody.innerHTML = '';
            for (let r in rooms) {
                const { count, lightOn } = rooms[r];
                const occupancy = Math.min(((count / maxCapacity) * 100).toFixed(1), 100);
                tbody.innerHTML += `<tr><td>${r}</td><td>${count}</td><td class="${lightOn ? 'on-status' : 'off-status'}">${lightOn ? 'ON' : 'OFF'}</td><td>${occupancy}%</td></tr>`;
            }
        }

        async function sendUpdateToBackend(roomName) {
            try {
                const payload = { room: roomName, count: rooms[roomName].count, lightOn: rooms[roomName].lightOn };
                await fetch((API_BASE || "") + "/api/update", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
            } catch (err) { console.warn("Update failed", err); }
        }

        async function sendCommandToBackend(roomName, action, value) {
            try {
                const payload = { room: roomName, action: action, value: value };
                await fetch((API_BASE || "") + "/api/command", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "x-api-key": ADMIN_PASSWORD },
                    body: JSON.stringify(payload)
                });
            } catch (err) { console.error("Command failed", err); }
        }

        // Init
        fetchStatus();
        setInterval(fetchStatus, 1000); // Check server every 1 second
    </script>
</body>

</html>
